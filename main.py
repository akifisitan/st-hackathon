import gradio as gr
from dotenv import load_dotenv
from langchain.schema import AIMessage, HumanMessage
from langchain_openai import ChatOpenAI

load_dotenv()

system_prompt = """
Sen kullanıcının harcamalarına göre harcama ve tasarruf tavsiyesi veren bir botsun. 
Bu konular dışında hiç bir soruya cevap verme.

Kullanıcı son 1 senelik harcama verisi : 
2023-01-31,30000,26841.049763255538,3158.950236744462,9394.367417139438,5368.209952651108,2684.104976325554,2684.104976325554,1342.052488162777,2147.2839810604432,1878.8734834278878,1342.052488162777
2023-02-28,30000,31777.639420895204,-1777.6394208952042,11122.17379731332,6355.527884179041,3177.7639420895207,3177.7639420895207,1588.8819710447603,2542.2111536716166,2224.4347594626647,1588.8819710447603
2023-03-31,30000,22995.106732375396,7004.893267624604,8048.287356331388,4599.02134647508,2299.51067323754,2299.51067323754,1149.75533661877,1839.6085385900317,1609.657471266278,1149.75533661877
2023-04-30,30000,27713.516576204172,2286.4834237958275,9699.73080167146,5542.703315240835,2771.3516576204174,2771.3516576204174,1385.6758288102087,2217.0813260963337,1939.9461603342922,1385.6758288102087
2023-05-31,30000,28886.218532930638,1113.7814670693624,10110.176486525723,5777.243706586128,2888.621853293064,2888.621853293064,1444.310926646532,2310.897482634451,2022.035297305145,1444.310926646532
2023-06-30,30000,20696.756190799966,9303.243809200034,7243.864666779988,4139.351238159993,2069.6756190799965,2069.6756190799965,1034.8378095399983,1655.7404952639972,1448.7729333559978,1034.8378095399983
2023-07-31,30000,29113.172778521577,886.8272214784229,10189.61047248255,5822.634555704316,2911.317277852158,2911.317277852158,1455.658638926079,2329.0538222817263,2037.9220944965107,1455.658638926079
2023-08-31,30000,22557.861855309373,7442.138144690627,7895.25164935828,4511.572371061875,2255.7861855309375,2255.7861855309375,1127.8930927654687,1804.62894842475,1579.0503298716562,1127.8930927654687
2023-09-30,30000,20975.77389477919,9024.226105220809,7341.520863172716,4195.154778955838,2097.577389477919,2097.577389477919,1048.7886947389595,1678.0619115823354,1468.3041726345434,1048.7886947389595
2023-10-31,30000,34233.2830588,-4233.2830588,11981.649070579999,6846.6566117600005,3423.3283058800002,3423.3283058800002,1711.6641529400001,2738.662644704,2396.3298141160003,1711.6641529400001
2023-11-30,30000,34484.48049611839,-4484.480496118391,12069.568173641435,6896.896099223679,3448.4480496118395,3448.4480496118395,1724.2240248059197,2758.7584396894713,2413.9136347282874,1724.2240248059197
2023-12-31,30000,32125.960221746915,-2125.9602217469146,11244.086077611419,6425.192044349384,3212.596022174692,3212.596022174692,1606.298011087346,2570.076817739753,2248.817215522284,1606.298011087346

Kullanıcı güncel maaşı : 30000
Yaş : 22
Meslek : Öğrenci
Cinsiyet : Erkek

Kullanıcı yalnızca şu soruları sorabilir , bu sorular dışındaki sorulara cevap verme: 
"Gelecek <TIME> ay için <MONEY> tasarruf etmek istiyorum"
"En çok hangi kategoride harcama yapıyorum?"
"Bu ay ne kadar tasarruf ettim?"
"Aylık ortalama harcamam nedir?"
"Harcamalarımın % kaçını ne kategoride harcıyorum?"
"""


llm = ChatOpenAI(temperature=1.0, model="gpt-4o-mini")


def predict(message, history):
    history_langchain_format = []
    history_langchain_format.append(AIMessage(content=system_prompt))
    for msg in history:
        if msg["role"] == "user":
            history_langchain_format.append(HumanMessage(content=msg["content"]))
        elif msg["role"] == "assistant":
            history_langchain_format.append(AIMessage(content=msg["content"]))
    history_langchain_format.append(HumanMessage(content=message))
    gpt_response = llm(history_langchain_format)
    return gpt_response.content


gr.ChatInterface(predict, type="messages").launch()
